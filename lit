#!/usr/bin/env bash
set -eu
set -o pipefail
self=$(basename $0)
for arg in "$@"; do
	if echo "$arg" | grep '=' >/dev/null 2>&1; then
		arg_name=$(echo $arg | sed 's =.*  ')
		arg_value=$(echo $arg | sed 's ^[^=]*=  ')
		eval ${arg_name}='${arg_value}'
		shift
	else
		break
	fi
done
test -n "$lit"
tag=${tag-}
variant=${variant-default}
file=${file-}
if test -n "$file"; then
	dir=$(dirname $file)
	if test -z "$tag"; then
		tag=$file
	fi
	if ! test -d "$dir"; then
		mkdir -p $dir
	fi
	sed -n "s,^	${tag}: ,,p;s,^	${tag}:${variant}: ,,p" $lit >$file
	chmod +x $file
	nocomment=${nocomment-false}
	if ! $nocomment; then
		case $file in
		    *.c|*.h)
		        echo "/* DO NOT EDIT THIS FILE.  Auto-generated from $lit by $self. */" >>$file
		        ;;
		    *)
		        echo "# DO NOT EDIT THIS FILE.  Auto-generated from $lit by $self." >>$file
		        ;;
		esac
	fi
	ext=$(echo $file | sed 's .*\.  ')
fi
run=${run-}
if test -n "$run"; then
	tag=${tag:-$(echo $run | sed 's,[	 ].*$,,')}
	ext=$tag
	case $tag in
		perl)
			ext=pl
			;;
		python)
			ext=py
			;;
		ruby)
			ext=rb
			;;
	esac
	sed -n "s,^	${tag}: ,,p;s,^	${tag}:${variant}: ,,p" $lit >${lit}.${ext}
	$run ${lit}.${ext} "$@"
fi
if test -z "$tag"; then
	sed -n 's,^	\([^ ]\+\): .*,\1,p' $lit | sort | uniq
fi
